"use strict";function animSplash(a){$(a).clearQueue(),$(a).is(":animated")||$(a).animate({opacity:1,width:430},80,function(){timeOut=setTimeout(function(){$(a).animate({opacity:0,width:20},500)},1300)})}function update(a){function l(a,b,c){var d,e,f,g,h;for(d=0;d<cars.length;d++)e=cars[d],f=findSegment(e.z),e.offset=e.offset+m(e,f,b,c),e.z=Util.increase(e.z,a*e.speed,trackLength),e.percent=Util.percentRemaining(e.z,segmentLength),g=findSegment(e.z),f!==g&&(h=f.cars.indexOf(e),f.cars.splice(h,1),g.cars.push(e))}function m(a,b,c,d){var e,f,g,h,i,j,k=20,l=a.sprite.w*SPRITES.SCALE;if(b.index-c.index>drawDistance)return 0;for(e=1;k>e;e++){if(h=segments[(b.index+e)%segments.length],h===c&&a.speed>speed&&Util.overlap(playerX,d,a.offset,l,1.2))return g=playerX>.5?-1:-.5>playerX?1:a.offset>playerX?1:-1,1*g/e*(a.speed-speed)/maxSpeed;for(f=0;f<h.cars.length;f++)if(i=h.cars[f],j=i.sprite.w*SPRITES.SCALE,a.speed>i.speed&&Util.overlap(a.offset,l,i.offset,j,1.2))return g=i.offset>.5?-1:i.offset<-.5?1:a.offset>i.offset?1:-1,1*g/e*(a.speed-i.speed)/maxSpeed}return a.offset<-.9?.1:a.offset>.9?-.1:0}var b,c,d,e,f,g=findSegment(position+playerZ),h=SPRITES.PLAYER_STRAIGHT.w*SPRITES.SCALE,i=speed/maxSpeed,j=2*a*i,k=position;for(l(a,g,h),position=Util.increase(position,a*speed,trackLength),keyLeft?playerX-=j:keyRight&&(playerX+=j),playerX-=j*i*g.curve*centrifugal,speed=keyFaster&&$(".bt-begin").hasClass("canBegin")?Util.accelerate(speed,accel,a):keySlower?Util.accelerate(speed,breaking,a):Util.accelerate(speed,decel,a),(-1>playerX||playerX>1)&&speed>offRoadLimit&&(speed=Util.accelerate(speed,offRoadDecel,a)),b=0;b<g.sprites.length;b++)if(e=g.sprites[b],f=e.source.w*SPRITES.SCALE,672===e.source.w);else if(36===e.source.w)Util.overlap(playerX,h,e.offset+f/2*(e.offset>0?1:-1),f)&&animSplash(".splash img");else if(103===e.source.w){if(Util.overlap(playerX,h-.3,e.offset+f/2*(e.offset>0?1:-1),f)){speed=maxSpeed/5,position=Util.increase(g.p1.world.z,-playerZ,trackLength);break}}else if(Util.overlap(playerX,h,e.offset+f/2*(e.offset>0?1:-1),f)){speed=maxSpeed/5,position=Util.increase(g.p1.world.z,-playerZ,trackLength);break}for(b=0;b<g.cars.length;b++)if(c=g.cars[b],d=c.sprite.w*SPRITES.SCALE,speed>c.speed&&Util.overlap(playerX,h,c.offset,d,.8)){speed=c.speed*(c.speed/speed),position=Util.increase(c.z,-playerZ,trackLength);break}playerX=Util.limit(playerX,-3,3),speed=Util.limit(speed,0,maxSpeed),skyOffset=Util.increase(skyOffset,skySpeed*g.curve*(position-k)/segmentLength,1),hillOffset=Util.increase(hillOffset,hillSpeed*g.curve*(position-k)/segmentLength,1),treeOffset=Util.increase(treeOffset,treeSpeed*g.curve*(position-k)/segmentLength,1),position>playerZ&&(currentLapTime&&playerZ>k?(lastLapTime=currentLapTime,currentLapTime=0,finish(formatTime(lastLapTime))):currentLapTime+=a),updateHud("speed",1.6*5*Math.round(speed/500)),updateHud("current_lap_time",formatTime(currentLapTime))}function updateHud(a,b){hud[a].value!==b&&(hud[a].value=b,Dom.set(hud[a].dom,b))}function formatTime(a){var b=Math.floor(a/60),c=Math.floor(a-60*b),d=Math.floor(10*(a-Math.floor(a)));return b>0?b+":"+(10>c?"0":"")+c+"."+d:c+"."+d}function render(){var a=findSegment(position),b=Util.percentRemaining(position,segmentLength),c=findSegment(position+playerZ),d=Util.percentRemaining(position+playerZ,segmentLength),e=Util.interpolate(c.p1.world.y,c.p2.world.y,d),f=height,g=0,h=-(a.curve*b);ctx.clearRect(0,0,width,height),Render.background(ctx,background,width,height,BACKGROUND.SKY,skyOffset,resolution*skySpeed*e),Render.background(ctx,background,width,height,BACKGROUND.BUILDINGS,hillOffset,resolution*hillSpeed*e);var i,j,k,l,m,n,o,p;for(i=0;drawDistance>i;i++)k=segments[(a.index+i)%segments.length],k.looped=k.index<a.index,k.fog=Util.exponentialFog(i/drawDistance,fogDensity),k.clip=f,Util.project(k.p1,playerX*roadWidth-g,e+cameraHeight,position-(k.looped?trackLength:0),cameraDepth,width,height,roadWidth),Util.project(k.p2,playerX*roadWidth-g-h,e+cameraHeight,position-(k.looped?trackLength:0),cameraDepth,width,height,roadWidth),g+=h,h+=k.curve,k.p1.camera.z<=cameraDepth||k.p2.screen.y>=k.p1.screen.y||k.p2.screen.y>=f||(Render.segment(ctx,width,lanes,k.p1.screen.x,k.p1.screen.y,k.p1.screen.w,k.p2.screen.x,k.p2.screen.y,k.p2.screen.w,k.fog,k.color),f=k.p1.screen.y);for(i=drawDistance-1;i>0;i--){for(k=segments[(a.index+i)%segments.length],j=0;j<k.cars.length;j++)l=k.cars[j],m=l.sprite,n=Util.interpolate(k.p1.screen.scale,k.p2.screen.scale,l.percent),o=Util.interpolate(k.p1.screen.x,k.p2.screen.x,l.percent)+n*l.offset*roadWidth*width/2,p=Util.interpolate(k.p1.screen.y,k.p2.screen.y,l.percent),Render.sprite(ctx,width,height,resolution,roadWidth,sprites,l.sprite,n,o,p,-.5,-1,k.clip);for(j=0;j<k.sprites.length;j++)m=k.sprites[j],n=k.p1.screen.scale,o=k.p1.screen.x+n*m.offset*roadWidth*width/2,p=k.p1.screen.y,672===m.source.w?Render.sprite(ctx,width,height,resolution,roadWidth,sprites,m.source,n,o,p,m.offset,-1,k.clip):Render.sprite(ctx,width,height,resolution,roadWidth,sprites,m.source,n,o,p,m.offset<0?-1:0,-1,k.clip);k===c&&Render.player(ctx,width,height,resolution,roadWidth,sprites,speed/maxSpeed,cameraDepth/playerZ,width/2,height/2-cameraDepth/playerZ*Util.interpolate(c.p1.camera.y,c.p2.camera.y,d)*height/2,speed*(keyLeft?-1:keyRight?1:0),c.p2.world.y-c.p1.world.y)}}function findSegment(a){return segments[Math.floor(a/segmentLength)%segments.length]}function lastY(){return 0===segments.length?0:segments[segments.length-1].p2.world.y}function addSegment(a,b){var c=segments.length;segments.push({index:c,p1:{world:{y:lastY(),z:c*segmentLength},camera:{},screen:{}},p2:{world:{y:b,z:(c+1)*segmentLength},camera:{},screen:{}},curve:a,sprites:[],cars:[],color:Math.floor(c/rumbleLength)%2?COLORS.DARK:COLORS.LIGHT})}function addSprite(a,b,c){segments[a].sprites.push({source:b,offset:c})}function addRoad(a,b,c,d,e){var h,f=lastY(),g=f+Util.toInt(e,0)*segmentLength,i=a+b+c;for(h=0;a>h;h++)addSegment(Util.easeIn(0,d,h/a),Util.easeInOut(f,g,h/i));for(h=0;b>h;h++)addSegment(d,Util.easeInOut(f,g,(a+h)/i));for(h=0;c>h;h++)addSegment(Util.easeInOut(d,0,h/c),Util.easeInOut(f,g,(a+b+h)/i))}function addStraight(a){a=a||ROAD.LENGTH.MEDIUM,addRoad(a,a,a,0,0)}function addHill(a,b){a=a||ROAD.LENGTH.MEDIUM,b=b||ROAD.HILL.MEDIUM,addRoad(a,a,a,0,b)}function addCurve(a,b,c){a=a||ROAD.LENGTH.MEDIUM,b=b||ROAD.CURVE.MEDIUM,c=c||ROAD.HILL.NONE,addRoad(a,a,a,b,c)}function addLowRollingHills(a,b){a=a||ROAD.LENGTH.SHORT,b=b||ROAD.HILL.LOW,addRoad(a,a,a,0,b/2),addRoad(a,a,a,0,-b),addRoad(a,a,a,ROAD.CURVE.EASY,b),addRoad(a,a,a,0,0),addRoad(a,a,a,-ROAD.CURVE.EASY,b/2),addRoad(a,a,a,0,0)}function addSCurves(){addRoad(ROAD.LENGTH.MEDIUM,ROAD.LENGTH.MEDIUM,ROAD.LENGTH.MEDIUM,-ROAD.CURVE.EASY,ROAD.HILL.NONE),addRoad(ROAD.LENGTH.MEDIUM,ROAD.LENGTH.MEDIUM,ROAD.LENGTH.MEDIUM,ROAD.CURVE.MEDIUM,ROAD.HILL.MEDIUM),addRoad(ROAD.LENGTH.MEDIUM,ROAD.LENGTH.MEDIUM,ROAD.LENGTH.MEDIUM,ROAD.CURVE.EASY,-ROAD.HILL.LOW),addRoad(ROAD.LENGTH.MEDIUM,ROAD.LENGTH.MEDIUM,ROAD.LENGTH.MEDIUM,-ROAD.CURVE.EASY,ROAD.HILL.MEDIUM),addRoad(ROAD.LENGTH.MEDIUM,ROAD.LENGTH.MEDIUM,ROAD.LENGTH.MEDIUM,-ROAD.CURVE.MEDIUM,-ROAD.HILL.MEDIUM)}function addBumps(){addRoad(10,10,10,0,5),addRoad(10,10,10,0,-2),addRoad(10,10,10,0,-5),addRoad(10,10,10,0,8),addRoad(10,10,10,0,5),addRoad(10,10,10,0,-7),addRoad(10,10,10,0,5),addRoad(10,10,10,0,-2)}function addDownhillToEnd(a){a=a||200,addRoad(a,a,a,-ROAD.CURVE.EASY,-lastY()/segmentLength)}function resetRoad(){segments=[],addStraight(ROAD.LENGTH.SHORT),addLowRollingHills(),addBumps(),addLowRollingHills(),addCurve(ROAD.LENGTH.LONG,-ROAD.CURVE.MEDIUM,ROAD.HILL.HIGH),addHill(ROAD.LENGTH.MEDIUM,ROAD.HILL.HIGH),addCurve(ROAD.LENGTH.LONG,-ROAD.CURVE.MEDIUM,ROAD.HILL.NONE),addHill(ROAD.LENGTH.LONG,ROAD.HILL.HIGH),addBumps(),addHill(ROAD.LENGTH.LONG,-ROAD.HILL.MEDIUM),addCurve(ROAD.LENGTH.LONG,-ROAD.CURVE.HARD,ROAD.HILL.MEDIUM),addSCurves(),addDownhillToEnd(),resetSprites(),resetCars(),segments[findSegment(playerZ).index+3].color=COLORS.START;for(var a=0;rumbleLength>a;a++)segments[segments.length-1-a].color=COLORS.FINISH;trackLength=segments.length*segmentLength}function resetSprites(){var a;addSprite(40,SPRITES.PLACA06,-1),addSprite(60,SPRITES.PLACA08,1),addSprite(80,SPRITES.PLACA09,-1),addSprite(100,SPRITES.PLACA01,1),addSprite(120,SPRITES.PLACA02,-1),addSprite(140,SPRITES.PLACA03,1),addSprite(160,SPRITES.PLACA04,-1),addSprite(180,SPRITES.PLACA05,1),addSprite(240,SPRITES.PLACA07,-1),addSprite(240,SPRITES.PLACA06,1),addSprite(340,SPRITES.PLACA03,-1),addSprite(460,SPRITES.PLACA04,1),addSprite(640,SPRITES.PLACA05,-1),addSprite(760,SPRITES.PLACA08,1),addSprite(segments.length-10,SPRITES.PARKEDTRUCK_LEFT1,-1),addSprite(segments.length-30,SPRITES.PARKEDTRUCK_LEFT2,-1),addSprite(segments.length-10,SPRITES.PARKEDTRUCK_RIGHT1,1),addSprite(segments.length-30,SPRITES.PARKEDTRUCK_RIGHT2,1),addSprite(4,SPRITES.CHESS,-.35);var b;for(a=800;a<segments.length-500;a+=80)b=Util.randomChoice([1,-1]),addSprite(a+Util.randomInt(0,50),Util.randomChoice(SPRITES.PLACAS),-b);for(a=100;a<segments.length-500;a+=200){var c=1.6*Math.random()-.8,d=c.toFixed(1);("0.0"===d||"-0.0"===d)&&(d=.1),addSprite(a+Util.randomInt(0,50),Util.randomChoice(SPRITES.OBSTACLES),-d)}for(a=200;a<segments.length-500;a+=100){var e=1.6*Math.random()-.8,f=e.toFixed(1);("0.0"===f||"-0.0"===f)&&(f=.1),addSprite(a+Util.randomInt(0,50),Util.randomChoice(SPRITES.TALHERES),-f)}}function resetCars(){cars=[];var a,b,c,d,e,f,g;for(a=0;totalCars>a;a++)d=Math.random()*Util.randomChoice([-.8,.8]),e=Math.floor(Math.random()*segments.length)*segmentLength,f=Util.randomChoice(SPRITES.CARS),g=maxSpeed/4+Math.random()*maxSpeed/(f===SPRITES.TRUCK1?4:2),b={offset:d,z:e,sprite:f,speed:g},c=findSegment(b.z),c.cars.push(b),cars.push(b)}function reset(a){a=a||{},canvas.width=width=Util.toInt(a.width,width),canvas.height=height=Util.toInt(a.height,height),lanes=Util.toInt(a.lanes,lanes),roadWidth=Util.toInt(a.roadWidth,roadWidth),cameraHeight=Util.toInt(a.cameraHeight,cameraHeight),drawDistance=Util.toInt(a.drawDistance,drawDistance),fogDensity=Util.toInt(a.fogDensity,fogDensity),fieldOfView=Util.toInt(a.fieldOfView,fieldOfView),segmentLength=Util.toInt(a.segmentLength,segmentLength),rumbleLength=Util.toInt(a.rumbleLength,rumbleLength),cameraDepth=1/Math.tan(fieldOfView/2*Math.PI/180),playerZ=cameraHeight*cameraDepth,resolution=height/480,(0===segments.length||a.segmentLength||a.rumbleLength)&&resetRoad()}function callback(){return function(){console.log("Salvando sess\xe3o..."),webkitsss()}}function finish(a){Dom.set("time-result",a),console.log(a),console.log("Fim..."),webkitss(a.replace(/\:|\./g,"")),read_best_score(),setTimeout(callback(),2e3),$(".conclusion").fadeIn("fast"),liberar_opcoes(),$(".bt-begin").removeClass("canBegin");var b="http://apps.facebook.com/corridafoodtruck/";$(".facebook").click(function(c){c.preventDefault(),FB.ui({method:"feed",link:b,name:"Eu joguei o game \u201cCorrida do Food Truck\u201d, do GNT, e meu tempo foi de  "+a+". Duvido me superar!",picture:"http://gntapps.com.br/corrida-food-truck/images/ImageShare.jpg",description:"A competi\xe7\xe3o n\xe3o \xe9 s\xf3 no programa Food Truck \u2013 A Batalha. Ven\xe7a a corrida, customize seu truck e desafie seus amigos.",message:"Mensagem"})});var c="https://twitter.com/intent/tweet?text=Eu joguei o game Corrida do Food Truck, do GNT, e meu tempo foi "+a+". Tente me superar http://goo.gl/BPUIq8";$(".twitter").attr("href",c),$(".twitter").click(function(a){a.preventDefault(),popupwindow(this.href,"Twitter",600,300)}),Game.run()}var fps=60,step=1/fps,width=640,height=480,centrifugal=.3,offRoadDecel=.99,skySpeed=.001,hillSpeed=.002,treeSpeed=.003,skyOffset=0,hillOffset=0,treeOffset=0,segments=[],cars=[],canvas=Dom.get("canvas"),ctx=canvas.getContext("2d"),background=null,sprites=null,resolution=null,roadWidth=2e3,segmentLength=200,rumbleLength=3,trackLength=null,lanes=3,fieldOfView=100,cameraHeight=1450,cameraDepth=null,drawDistance=300,playerX=0,playerZ=null,fogDensity=10,position=0,speed=0,maxSpeed=segmentLength/step,accel=maxSpeed/5,breaking=-maxSpeed,decel=-maxSpeed/5,offRoadDecel=-maxSpeed/2,offRoadLimit=maxSpeed/4,totalCars=130,currentLapTime=0,lastLapTime=null,keyLeft=!1,keyRight=!1,keyFaster=!1,keySlower=!1,hud={speed:{value:null,dom:Dom.get("speed_value")},current_lap_time:{value:null,dom:Dom.get("current_lap_time_value")},last_lap_time:{value:null,dom:Dom.get("last_lap_time_value")},fast_lap_time:{value:null,dom:Dom.get("fast_lap_time_value")}};canvas.tabIndex=1;var timeOut,ROAD={LENGTH:{NONE:0,SHORT:25,MEDIUM:50,LONG:100},HILL:{NONE:0,LOW:20,MEDIUM:40,HIGH:60},CURVE:{NONE:0,EASY:2,MEDIUM:4,HARD:6}};Game.run({canvas:canvas,render:render,update:update,step:step,images:["background","sprites"],keys:[{keys:[KEY.LEFT,KEY.A],mode:"down",action:function(){keyLeft=!0}},{keys:[KEY.RIGHT,KEY.D],mode:"down",action:function(){keyRight=!0}},{keys:[KEY.UP,KEY.W],mode:"down",action:function(){keyFaster=!0}},{keys:[KEY.DOWN,KEY.S],mode:"down",action:function(){keySlower=!0}},{keys:[KEY.LEFT,KEY.A],mode:"up",action:function(){keyLeft=!1}},{keys:[KEY.RIGHT,KEY.D],mode:"up",action:function(){keyRight=!1}},{keys:[KEY.UP,KEY.W],mode:"up",action:function(){keyFaster=!1}},{keys:[KEY.DOWN,KEY.S],mode:"up",action:function(){keySlower=!1}}],ready:function(a){background=a[0],sprites=a[1],reset(),Dom.storage.fast_lap_time=Dom.storage.fast_lap_time||180,updateHud("fast_lap_time",formatTime(Util.toFloat(Dom.storage.fast_lap_time)))}});